<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
    <head><link rel="stylesheet" type="text/css" href="description/Combined.css,0:HeaderFooterSprite,0:Header.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=C9973DA951AE6202C9B348379A1BE49D" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />
<link rel="stylesheet" type="text/css" href="description/0aac1760-b513-488a-ba57-e31d9413a075Combined.css,0:HeaderFooterSprite,0:Footer.NonMtps,1:LinkList;/Areas/Centers/Themes/StandardDevCenter/Content:0,/Areas/Epx/Themes/Base/Content:1&amp;amp;hashKey=F576C687BC536B84D6E5B3246EE39B49" xmlns="http://www.w3.org/1999/xhtml" />
<link type="text/css" rel="stylesheet" xmlns="http://www.w3.org/1999/xhtml" />

        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>Lync Server: Extend Unified Communications Services of UCMA Bots to PIC Clients</title>
        <link href="description/Galleries.css" type="text/css" rel="Stylesheet" /><link href="description/Layout.css" type="text/css" rel="Stylesheet" /><link href="description/Brand.css" type="text/css" rel="Stylesheet" />
        <link href="description/iframedescription.css" rel="Stylesheet" type="text/css" />
        <script src="description/offline.js" type="text/javascript"></script>
        <style type="text/css">
            #projectInfo {
                overflow: auto;
            }
            #longDesc {
                clear:both;
                margin: 25px 0 10px 0;
            }

            #SampleIndexList{
                margin-left: 15px;
            }
        </style>
    </head>
<body>
    <div id="offlineDescription">
        <h1>Lync Server: Extend Unified Communications Services of UCMA Bots to PIC Clients</h1>
        <br/>
        <div id="projectInfo">
            <div class="section">
                    <div class="itemBarLong tagsContainer">
                        <label for="Technologies">Technologies</label>
                        <div id="Technologies">
                            Lync Server 2010, Lync Server 2013
                        </div>
                    </div>
                    <div class="itemBarLong tagsContainer">
                        <label for="Topics">Topics</label>
                        <div id="Topics">
                            unified communication services, bot
                        </div>
                    </div>
                <div class="itemBarLong">
                    <label for="Platforms">Platforms</label>
                    <div id="Platforms">
                        Desktop
                    </div>
                </div>
                <div class="itemBarLong">
                    <label for="Requirements">Requirements</label>
                    <div id="Requirements">
                        
                    </div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Primary language</label>
                    <div id="LastUpdated">en-US</div>
                </div>
                <div class="itemBar">
                    <label for="LastUpdated">Updated</label>
                    <div id="LastUpdated">8/12/2013</div>
                </div>
                <div class="itemBarLong">
                    <label for="License">License</label>
                    <div id="License">
                        <a href="license.rtf">Apache License, Version 2.0</a></div>
                </div>
                <div class="itemBar">
                    <div class="viewonlinecont">
                        <a data-link="online" href="http://code.msdn.microsoft.com/Lync-2010-Extending-2da6ee99">View this sample online</a>
                    </div>
                </div>
            </div>
        </div>
        
                   
<script type="text/javascript">
    function initializePage() {
        var otherTabClass = 'otherTab';
        var hiddenPreClass = 'hidden';

        var htmlDecode = function(encodedData) {
            var decodedData = "";
            if (encodedData) {
                var div = document.createElement('div');
                div.innerHTML = encodedData;
                decodedData = div.firstChild.nodeValue.replace( /\\r\\n/ig , '\r\n');
            }
            return decodedData;
        };
                
        Galleries.iterateElem(Galleries.findElem(null, 'div', 'scriptcode'), function (index, scriptBlock) {
            var titleElem = Galleries.findElem(scriptBlock, 'div', 'title')[0];
            var labelElems = Galleries.findElem(titleElem, 'span');
            if (labelElems.length == 0) {
                labelElems = titleElem;
            }
            var languageSpans = Galleries.findElem(scriptBlock, 'span', 'hidden');
            var pres = Galleries.findElem(scriptBlock, 'pre');
            if (languageSpans.length > 0 && pres.length > 1) {
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    var languageSpan = languageSpans[index];
                            
                    elem.code = codePre.innerHTML.replace( /(\r(\n)?)|((\r)?\n)/ig , '\\r\\n');
                            
                    codePre.className = codePre.className.replace(hiddenPreClass, '');
                            
                    languageSpan.parentNode.removeChild(languageSpan);
                });

                pres = Galleries.findElem(scriptBlock, 'pre');
                Galleries.iterateElem(labelElems, function(index, elem) {
                    var codePre = pres[index];
                    var labelSpan = elem;
                    if (index == 0) {
                        scriptBlock.activeTab = 0;
                    }
                    else {
                        labelSpan.className += otherTabClass;
                        codePre.className += hiddenPreClass;
                    }
                    Galleries.attachEventHandler(labelSpan, 'click', function(e) {
                        var activeTab = scriptBlock.activeTab;
                        labelElems[activeTab].className += otherTabClass;
                        pres[activeTab].className += hiddenPreClass;

                        codePre.className = codePre.className.replace(hiddenPreClass, '');
                        labelSpan.className = labelSpan.className.replace(otherTabClass, '');
                        scriptBlock.activeTab = index;
                    });
                });

                var preview = Galleries.findElem(scriptBlock, 'div', 'preview');
                if (preview.length == 0) {
                    preview.push(pres[pres.length - 1]);
                }
                Galleries.iterateElem(preview, function(index, elem) {
                    elem.parentNode.removeChild(elem);
                });

                if (window.clipboardData && clipboardData.setData) {
                    var copyLink = document.createElement('a');
                    copyLink.href = 'javascript:void(0);';
                    copyLink.className = 'copyCode';
                    copyLink.innerHTML = 'Copy code';
                    Galleries.attachEventHandler(copyLink, 'click', function (e) {
                        clipboardData.setData("Text", htmlDecode(labelElems[scriptBlock.activeTab].code));
                        return false;
                    });
                    scriptBlock.insertBefore(copyLink, scriptBlock.childNodes[0]);
                }
            }
        });
    }

    Galleries.onWindowLoad(function(){
        initializePage();
    });

</script>
<div id="longDesc">
    
<div id="header">
<table id="bottomTable" cellpadding="0" cellspacing="0">
<tbody>
<tr id="headerTableRow1">
<td align="left"><span id="runningHeaderText"></span></td>
</tr>
<tr id="headerTableRow2">
<td align="left"><span id="nsrTitle">Lync Server: Extending Unified Communications Services of UCMA bots to PIC clients</span>
</td>
</tr>
</tbody>
</table>
</div>
<div id="mainSection">
<div id="mainBody">
<div>
<p>This sample shows how to extend Microsoft Lync Server-supported unified communications services provided by a trusted Microsoft Unified Communications Managed API (UCMA) bot application to Public Internet Cloud (PIC) clients.</p>
</div>
<div>
<p>The application runs as a server-side application and intercepts SUBSCRIBE requests from PIC Clients. If the subscription request is for a bot and non-terminating, the application returns an 'online' ('open') presence state.</p>
</div>
<h1>Description</h1>
<div id="sectionSection0" name="collapseableSection">
<p><b>Problem</b>: Lync clients subscribing to an automaton ('bot'), have a special logic to handle bots' presence updates. PIC clients don't have this special logic to present presence information for bots to PIC clients.</p>
<p><b>Solution</b>: This application runs as a server-side application and intercepts SUBSCRIBE requests from PIC Clients. If the subscription request is for a bot and non-terminating, this application returns an 'online' ('open') presence state.</p>
<p>This application also periodically checks for newly added application endpoints (bots). When a subscription request from a PIC client comes in, the application checks the SIPUri for the target and if the target of the subscription is an application endpoint,
 then this application returns 'online' for the presence state.</p>
</div>
<h1>Features</h1>
<div id="sectionSection1" name="collapseableSection">
<p>Server-side MSPL application running as a UCMA ApplicationEndpoint to send presence update on behalf of a bot:</p>
<ul>
<li>
<p>Intercepting presence SUBSCRIBE by PIC client in an MSPL script</p>
</li><li>
<p>Handling the SUBSCRIBE requests in a managed Lync Server API application</p>
</li><li>
<p>Sending SIP 200 OK response using Microsoft.Rtc.Sip namespace</p>
</li><li>
<p>Sending NOTIFY message containing bot's presence using <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/Microsoft.Rtc.Collaboration.aspx"  title="Auto generated link to Microsoft.Rtc.Collaboration">Microsoft.Rtc.Collaboration</a> namespace</p>
</li><li>
<p>Obtaining installed bots using Lync Server Management Shell cmdlets with the help of the <a class="libraryLink" href="http://msdn.microsoft.com/en-US/library/System.Management.Automation.aspx"  title="Auto generated link to System.Management.Automation">System.Management.Automation</a> namespace</p>
</li><li>
<p>Maintaining cached list of installed bots in a background thread</p>
</li></ul>
</div>
<h1>Prerequisites</h1>
<div id="sectionSection2" name="collapseableSection">
<ul>
<li>
<p>Lync Server 2013 or Lync Server 2010 deployment with federated access</p>
</li><li>
<p>PIC Client (Skype)</p>
</li><li>
<p>Public IM enabled on the Lync Server</p>
</li></ul>
</div>
<h1>Running the sample</h1>
<div id="sectionSection3" name="collapseableSection">
<p>Prerequisites to compile the sample:</p>
<ul>
<li>
<p>UCMA 4.0 SDK or UCMA 3.0 Core SDK must be installed on the development machine.</p>
</li><li>
<p>Lync Server 2013 SDK or Lync Server 2010 SDK must be installed on the development machine.</p>
</li></ul>
</div>
<h1>Run and test the sample</h1>
<div id="sectionSection5" name="collapseableSection">
<ol>
<li>
<p>Compile the sample - Set up the references to the UCMA 4.0 SDK/UCMA 3.0 Core SDK and the Lync Server 2013 SDK/Lync Server 2010 SDK.</p>
</li><li>
<p>The account that the application runs as must be a member of the 'RTC Server Applications' local group and a member of the 'Local Administrators' group.</p>
</li><li>
<p>You must then register the Server Application with the Lync Server. To do this perform the following steps:
</p>
<ol>
<li>
<p>Open the Lync Server Management Shell console.</p>
</li><li>
<p>Run the following Windows PowerShell command:</p>
</li></ol>
</li></ol>
<p><span>New-CsServerApplication |</span> <br>
<span>-Uri http://www.microsoft.com/lyncSever/sdk/samples/PresenceSubInterceptorForBot |</span>
<br>
<span>-Critical $false |</span> <br>
<span>-Priority 2 |</span> <br>
<span>-Identity &quot;Service:Registrar:&lt;yourRegistrarFqdn&gt;/presenceInterceptor&quot; |</span>
<br>
<span>-enabled $true</span> <br>
</p>
<p>The above Windows PowerShell script creates the server application and installs it on the Lync Server to which the &quot;user&quot; is homed. The Uri parameter value must match that of the appUri in the corresponding MSPL application manifest file. The Priority value
 (2) could well be higher than that of the UserServices. This is acceptable because the &lt;allowRegistrationBeforeUserServices/&gt; element is present in the corresponding application manifest.</p>
<h3>Register the UCMA application</h3>
<div>
<ol>
<li>
<p>Create the UCMA Application Pool using Windows PowerShell<br>
<span>New-TrustedApplicationPool -Identity &lt;PoolName&gt; -Registrar &lt;Registrar&gt; -Site &lt;SiteName&gt;</span><br>
where &lt;Registrar&gt; and &lt;SiteName&gt; are the names of the registrar service and the site</p>
</li><li>
<p>Create the Trusted Application<br>
<span>New-CsTrustedApplication -Identity &lt;PoolName&gt;/presencesubinterceptorforbot |</span><br>
<span>-Port &lt;PortNumber&gt;</span></p>
</li><li>
<p>Create the trusted application endpoint<br>
<span>-SipAddress sip:picinterceptor@&lt;domain&gt;.com |</span><br>
<span>-DisplayName &quot;PresenceSubInterceptor&quot; |</span><br>
<span>-ApplicationId &quot;urn:application:presencesubinterceptorforbot&quot; |</span><br>
<span>-TrustedApplicationPoolFqdn &lt;PoolName&gt;</span></p>
</li></ol>
</div>
</div>
<h1>Running the sample</h1>
<div id="sectionSection6" name="collapseableSection">
<ol>
<li>
<p>Copy the presenceSubInterceptorForBot.am file to the folder where <b>presenceSubInterceptorForBot.exe</b> is located.</p>
</li><li>
<p>Copy the <b>PresenceSubInterceptorForBot.exe.config</b> file to where the executable is located.</p>
</li><li>
<p>Go the folder where the executable is located, run the <b>PresenceSubInterceptor.exe</b> program.</p>
</li></ol>
</div>
<h1>Change log</h1>
<div id="sectionSection7" name="collapseableSection">
<p>First release. 10/10/2012</p>
<p>Current release: changed synchronous calls to asynchronous calls using BeginXXX/EndXXX pattern. Explicitly reset the TO and FROM header values on the outgoing NOTIFY messages to the FROM and TO header values of the corresponding SUBSCRIBE messages, respectively.</p>
</div>
<h1>Related content</h1>
<div id="sectionSection8" name="collapseableSection">
<ul>
<li>
<p>MSDN Library: <a href="http://msdn.microsoft.com/en-us/library/jj128288.aspx" >
Extending Unified Communications Services of UCMA Bots to PIC Clients</a></p>
</li><li>
<p>MSDN Library: <a href="http://msdn.microsoft.com/en-us/library/gg421042.aspx" >
Microsoft Lync Server 2010 SDK Documentation</a></p>
</li><li>
<p>MSDN Library: <a href="http://msdn.microsoft.com/en-us/library/gg421023.aspx" >
Unified Communications Managed API 3.0 Core SDK Documentation</a></p>
</li><li>
<p>MSDN Library: <a href="http://msdn.microsoft.com/en-us/library/jj265300.aspx" >
Microsoft Lync Server 2013 SDK Documentation</a></p>
</li><li>
<p>MSDN Library: <a href="http://msdn.microsoft.com/en-us/library/jj728784.aspx" >
Unified Communications Managed API 4.0 SDK Documentation</a></p>
</li></ul>
</div>
</div>
</div>

</div>


    </div>
</body>
</html>
