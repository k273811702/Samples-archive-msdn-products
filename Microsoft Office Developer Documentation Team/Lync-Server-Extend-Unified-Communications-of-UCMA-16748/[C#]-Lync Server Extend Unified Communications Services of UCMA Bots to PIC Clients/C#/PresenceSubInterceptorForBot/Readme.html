<html>

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=Generator content="Microsoft Word 15 (filtered)">
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:Wingdings;
	panose-1:5 0 0 0 0 0 0 0 0 0;}
@font-face
	{font-family:SimSun;
	panose-1:2 1 6 0 3 1 1 1 1 1;}
@font-face
	{font-family:"Cambria Math";
	panose-1:2 4 5 3 5 4 6 3 2 4;}
@font-face
	{font-family:"Calibri Light";
	panose-1:2 15 3 2 2 2 4 3 2 4;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;}
@font-face
	{font-family:"\@SimSun";
	panose-1:2 1 6 0 3 1 1 1 1 1;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:0in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
h1
	{mso-style-link:"Heading 1 Char";
	margin-top:12.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:16.0pt;
	font-family:"Calibri Light","sans-serif";
	color:#2E74B5;
	font-weight:normal;}
h2
	{mso-style-link:"Heading 2 Char";
	margin-top:2.0pt;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:0in;
	margin-bottom:.0001pt;
	line-height:107%;
	page-break-after:avoid;
	font-size:13.0pt;
	font-family:"Calibri Light","sans-serif";
	color:#2E74B5;
	font-weight:normal;}
p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:.5in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:0in;
	margin-left:.5in;
	margin-bottom:.0001pt;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast
	{margin-top:0in;
	margin-right:0in;
	margin-bottom:8.0pt;
	margin-left:.5in;
	line-height:107%;
	font-size:11.0pt;
	font-family:"Calibri","sans-serif";}
span.Heading1Char
	{mso-style-name:"Heading 1 Char";
	mso-style-link:"Heading 1";
	font-family:"Calibri Light","sans-serif";
	color:#2E74B5;}
span.Heading2Char
	{mso-style-name:"Heading 2 Char";
	mso-style-link:"Heading 2";
	font-family:"Calibri Light","sans-serif";
	color:#2E74B5;}
.MsoChpDefault
	{font-family:"Calibri","sans-serif";}
.MsoPapDefault
	{margin-bottom:8.0pt;
	line-height:107%;}
@page WordSection1
	{size:8.5in 11.0in;
	margin:1.0in 1.0in 1.0in 1.0in;}
div.WordSection1
	{page:WordSection1;}
 /* List Definitions */
 ol
	{margin-bottom:0in;}
ul
	{margin-bottom:0in;}
-->
</style>

</head>

<body lang=EN-US>

<div class=WordSection1>

<h1>Title: PresenceSubInterceptorForBot</h1>

<p class=MsoNormal>&nbsp;</p>

<h1>Description</h1>

<p class=MsoNormal>This is a Visual Studio solution of a sample application to
illustrate how to extend Microsoft Lync Server  to enable publishing presence
status for enterprise bot for PIC clients.</p>

<h2>Problem: </h2>

<p class=MsoNormal>Lync clients subscribing to an automaton (aka bot), have a
special logic to handle bots' presence updates. PIC clients don't have this
special logic to present presence information for bots to PIC clients.</p>

<h2><span class=Heading2Char>S</span>olution:</h2>

<p class=MsoNormal>This application runs as a server-side application and
intercepts SUBSCRIBE requests from PIC Clients. If the subscription request is
for a bot and non-terminating, this application returns an 'online' (aka
'open') presence state. </p>

<p class=MsoNormal>This application also periodically checks for newly added
application endpoints (i.e., bots).  When a subscription request from a PIC
client comes in, the application checks the SIPUri for the target and if the
target of the subscription is an application endpoint, then this application
returns 'online' for the presence state.</p>

<h2>Features</h2>

<p class=MsoNormal>Server-side MSPL application running as an UCMA <b>ApplicationEndpoint</b>
to send presence update on behalf of a bot:</p>

<p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Intercepting presence SUBSCRIBE by PIC client in an MSPL script</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Handling the SUBSCRIBE requests in a managed Lync Server API
application</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Sending SIP 200 OK response using Microsoft.Rtc.Sip namespace</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Sending NOTIFY message containing bot's presence using
Microsoft.Rtc.Collaboration namespace</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Obtaining installed bots using Lync Server Management PowerShell
cmdlets with the help of the System.Management.Automation namespace</p>

<p class=MsoListParagraphCxSpLast style='text-indent:-.25in'><span
style='font-family:Symbol'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span></span>Maintaining cached list of installed bots in a background thread.</p>

<h2>Prerequisites</h2>

<p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Microsoft Lync Server 2013 deployment with federated access</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>PIC Client (Skype Messenger)</p>

<p class=MsoListParagraphCxSpLast style='text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Public IM enabled on the Lync Server</p>

<h2><span class=Heading2Char>R</span>unning the sample</h2>

<p class=MsoNormal>Prerequisites to compile the sample:</p>

<p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>UCMA 4.0 SDK must be installed on the development machine</p>

<p class=MsoListParagraphCxSpLast style='text-indent:-.25in'>-<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Lync Server 2013 SDK must be installed on the development machine</p>

<p class=MsoNormal>&nbsp;</p>

<h2>Installing the Server Application:</h2>

<p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Compile
the sample</p>

<p class=MsoListParagraphCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>a.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Set
up the references to the UCMA 4.0 SDK and the Lync Server 2013 SDK</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>The
account that the application runs as, must be a member of the 'RTC Server
Applications' local group and a member of the 'Local Administrators' group.</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>You
must then register the Server Application with the Lync Server. To do this perform
the following steps.</p>

<p class=MsoListParagraphCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'>a.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Open
the Lync Server Management PowerShell console</p>

<p class=MsoListParagraphCxSpLast style='margin-left:1.0in;text-indent:-.25in'>b.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Run
the following PowerShell command </p>

<p class=MsoNormal>      <i>New-CsServerApplication | <br>
               -Uri
http://www.microsoft.com/lyncSever/sdk/samples/PresenceSubInterceptorForBot | <br>
               -Critical $false |<br>
               -Priority 2 |<br>
               -Identity
&quot;Service:Registrar:&lt;yourRegistrarFqdn&gt;/presenceInterceptor&quot; |<br>
               -enabled $true</i></p>

<p class=MsoNormal style='margin-left:.5in'>The above PowerShell script creates
the server application and installs it on the Lync server to which the
&quot;user&quot; is homed.  The <i>Uri</i> parameter value must match that of
the <i>appUri</i> in the corresponding MSPL application manifest file. The <i>Priority</i>
value (2) could well be higher than that of the <b>UserServices</b>. This is
acceptable because the <i>&lt;allowRegistrationBeforeUserServices/&gt;</i>
element is present in the corresponding application manifest.</p>

<h2>Creating the UCMA Application:</h2>

<p class=MsoListParagraph style='text-indent:-.25in'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Create the UCMA Application Pool using PowerShell</p>

<p class=MsoNormal><i>               New-TrustedApplicationPool -Identity
&lt;PoolName&gt; -Registrar &lt;Registrar&gt; -Site &lt;SiteName&gt;</i></p>

<p class=MsoNormal>               where &lt;<i>Registrar</i>&gt; and &lt;<i>SiteName</i>&gt;
are the names of the registrar service and the site</p>

<p class=MsoListParagraph style='text-indent:-.25in'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Create the Trusted Application</p>

<p class=MsoNormal style='margin-left:.5in'><i>New-CsTrustedApplication
-Identity &lt;PoolName&gt;/presencesubinterceptorforbot  |<br>
                                               -Port &lt;PortNumber&gt;</i></p>

<p class=MsoNormal style='margin-left:.5in'>NOTE: In a Mixed (OCS 2007 R2)
environment, you will need to run <b>enable-cstopology</b> to ensure that the information
for OCS 2007 R2 contact objects is collected as well.</p>

<p class=MsoListParagraph style='text-indent:-.25in'>3.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
</span>Create the trusted application endpoint</p>

<p class=MsoNormal style='margin-left:.5in'><i>New-CsTrustedApplicationEndpoint
| <br>
               -SipAddress sip:picinterceptor@&lt;domain&gt;.com |<br>
               -DisplayName &quot;PresenceSubInterceptor&quot; | <br>
              -ApplicationId &quot;urn:application:presencesubinterceptorforbot&quot;
|<br>
             -TrustedApplicationPoolFqdn &lt;PoolName&gt;</i></p>

<p class=MsoNormal>&nbsp;</p>

<h2>Running the sample:</h2>

<p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'>1.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Copy
the <i>presenceSubInterceptorForBot.am</i> file to the folder where <b>presenceSubInterceptorForBot.exe</b>
is located.</p>

<p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'>2.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Copy
the <i>PresenceSubInterceptorForBot.exe.config</i> file to where the executable
is located.</p>

<p class=MsoListParagraphCxSpLast style='text-indent:-.25in'>3.<span
style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>Go
the folder where the executable is located, run the <b>PresenceSubInterceptor.exe</b>
program.</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

<p class=MsoNormal>&nbsp;</p>

</div>

</body>

</html>
